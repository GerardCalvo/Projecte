<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recollida Selectiva a Catalunya - ODS 11.6.1</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #ecf0f1;
            border-radius: 5px;
        }
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        select, input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .chart-container {
            position: relative;
            height: 500px;
            margin-bottom: 40px;
        }
        .info-box {
            background-color: #e8f4f8;
            padding: 15px;
            border-left: 4px solid #3498db;
            margin-bottom: 20px;
            border-radius: 0 4px 4px 0;
        }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }
        .legend-item {
            display: flex;
            align-items: center;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border-radius: 3px;
        }
        footer {
            text-align: center;
            margin-top: 30px;
            font-size: 0.9em;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Evolució de la Recollida Selectiva a Catalunya - ODS 11.6.1</h1>
        
        <div class="info-box">
            <p>Aquest gràfic mostra l'evolució del percentatge de recollida selectiva de residus municipals a Catalunya, comparat amb les metes de reciclatge establertes per la Directiva (UE) 2018/851. Les dades provenen de l'API de Transparència Catalunya.</p>
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <label for="municipi">Municipi:</label>
                <select id="municipi">
                    <option value="tots">Tots els municipis (mitjana Catalunya)</option>
                    <!-- Municipis s'omplen dinàmicament -->
                </select>
            </div>
            <div class="filter-group">
                <label for="any-inici">Any d'inici:</label>
                <select id="any-inici">
                    <option value="2000">2000</option>
                    <option value="2005">2005</option>
                    <option value="2010">2010</option>
                    <option value="2015" selected>2015</option>
                    <option value="2020">2020</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="mostrar-projeccio">Mostrar projecció:</label>
                <select id="mostrar-projeccio">
                    <option value="si">Sí</option>
                    <option value="no">No</option>
                </select>
            </div>
        </div>
        
        <div class="chart-container">
            <canvas id="recollidaChart"></canvas>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #3498db;"></div>
                <span>Recollida selectiva real</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #e74c3c;"></div>
                <span>Metes UE</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #2ecc71;"></div>
                <span>Projecció recollida selectiva</span>
            </div>
        </div>
        
        <footer>
            Font: API de Transparència Catalunya | Dades ODS 11.6.1 | Metes UE: Directiva (UE) 2018/851
        </footer>
    </div>

    <script>
        // Configuració inicial
        let allData = [];
        let municipis = [];
        let chart;
        
        // Colors per al gràfic
        const colors = {
            real: '#3498db',
            meta: '#e74c3c',
            projeccio: '#2ecc71'
        };
        
        // Metes UE
        const metesUE = {
            '2020': 50,
            '2025': 55,
            '2030': 60,
            '2035': 65
        };
        
        // Inicialització
        document.addEventListener('DOMContentLoaded', async function() {
            await carregarDades();
            inicialitzarFiltres();
            crearGrafic();
            
            // Afegir event listeners als filtres
            document.getElementById('municipi').addEventListener('change', actualitzarGrafic);
            document.getElementById('any-inici').addEventListener('change', actualitzarGrafic);
            document.getElementById('mostrar-projeccio').addEventListener('change', actualitzarGrafic);
        });
        
        // Carregar dades de l'API
        async function carregarDades() {
            try {
                const response = await fetch('../../BACKEND/api/residus.php');
                allData = await response.json();
                
                // Processar dades
                allData.forEach(d => {
                    d.any = parseInt(d.any);
                    d.r_s_r_m_total = parseFloat(d.r_s_r_m_total);
                    d.poblaci = parseInt(d.poblaci);
                });
                
                // Obtenir llista de municipis únics
                const municipisSet = new Set();
                allData.forEach(d => municipisSet.add(d.municipi));
                municipis = Array.from(municipisSet).sort();
                
            } catch (error) {
                console.error('Error carregant dades:', error);
            }
        }
        
        // Inicialitzar filtres
        function inicialitzarFiltres() {
            const selectMunicipi = document.getElementById('municipi');
            
            // Afegir municipis al select
            municipis.forEach(municipi => {
                const option = document.createElement('option');
                option.value = municipi;
                option.textContent = municipi;
                selectMunicipi.appendChild(option);
            });
        }
        
        // Crear gràfic inicial
        function crearGrafic() {
            const ctx = document.getElementById('recollidaChart').getContext('2d');
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Recollida selectiva real (%)',
                            data: [],
                            borderColor: colors.real,
                            backgroundColor: colors.real,
                            borderWidth: 3,
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'Metes UE de reciclatge (%)',
                            data: [],
                            borderColor: colors.meta,
                            backgroundColor: colors.meta,
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0,
                            fill: false
                        },
                        {
                            label: 'Projecció recollida selectiva (%)',
                            data: [],
                            borderColor: colors.projeccio,
                            backgroundColor: colors.projeccio,
                            borderWidth: 2,
                            borderDash: [3, 3],
                            tension: 0.1,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 70,
                            title: {
                                display: true,
                                text: 'Percentatge de recollida selectiva (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Any'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evolució de la Recollida Selectiva i Metes UE',
                            font: {
                                size: 18
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: {
                            display: false
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
            
            actualitzarGrafic();
        }
        
        // Actualitzar gràfic basat en filtres
        function actualitzarGrafic() {
            const municipiSeleccionat = document.getElementById('municipi').value;
            const anyInici = parseInt(document.getElementById('any-inici').value);
            const mostrarProjeccio = document.getElementById('mostrar-projeccio').value === 'si';
            
            // Obtenir dades filtrades
            let dadesFiltrades;
            
            if (municipiSeleccionat === 'tots') {
                // Calcular mitjana per a tots els municipis per any
                dadesFiltrades = calcularMitjanaCatalunya();
            } else {
                // Filtrar per municipi seleccionat
                dadesFiltrades = allData.filter(d => d.municipi === municipiSeleccionat);
            }
            
            // Filtrar per any d'inici
            dadesFiltrades = dadesFiltrades.filter(d => d.any >= anyInici && d.any <= 2023);
            
            // Ordenar per any
            dadesFiltrades.sort((a, b) => a.any - b.any);
            
            // Preparar dades per al gràfic
            const anys = dadesFiltrades.map(d => d.any.toString());
            const percentatges = dadesFiltrades.map(d => d.r_s_r_m_total);
            
            // Calcular projecció si s'ha seleccionat
            let projeccio = [];
            let anysProjeccio = [];
            
            if (mostrarProjeccio && dadesFiltrades.length > 0) {
                // Utilitzem els últims 5 anys per calcular la tendència
                const ultimsAnys = dadesFiltrades.slice(-5);
                const x = ultimsAnys.map(d => d.any);
                const y = ultimsAnys.map(d => d.r_s_r_m_total);
                
                // Regressió lineal simple per a la projecció
                const regression = linearRegression(x, y);
                
                // Calcular projecció per a 2024-2035
                for (let any = 2024; any <= 2035; any++) {
                    const prediccio = regression.slope * any + regression.intercept;
                    // No permetem percentatges negatius ni superiors al 100%
                    const valorPrediccio = Math.min(100, Math.max(0, prediccio));
                    
                    projeccio.push(valorPrediccio);
                    anysProjeccio.push(any.toString());
                }
            }
            
            // Preparar metes UE per als anys rellevants
            const metesAnys = [];
            const metesValors = [];
            
            Object.keys(metesUE).forEach(any => {
                if (parseInt(any) >= anyInici) {
                    metesAnys.push(any);
                    metesValors.push(metesUE[any]);
                }
            });
            
            // Afegir 2024 a les metes UE si no hi és (interpolat entre 2020 i 2025)
            if (mostrarProjeccio && !metesAnys.includes('2024') && anyInici <= 2024) {
                const valor2024 = 50 + (55-50)*(2024-2020)/(2025-2020); // Interpolació lineal
                metesAnys.splice(metesAnys.indexOf('2020')+1, 0, '2024');
                metesValors.splice(metesValors.indexOf(50)+1, 0, valor2024);
            }
            
            // Actualitzar gràfic
            chart.data.labels = anys.concat(mostrarProjeccio ? anysProjeccio : []);
            
            chart.data.datasets[0].data = percentatges.concat(mostrarProjeccio ? Array(anysProjeccio.length).fill(null) : []);
            chart.data.datasets[1].data = Array(anys.length).fill(null).concat(metesValors);
            chart.data.datasets[1].label = `Metes UE de reciclatge (%) - ${metesAnys.join(', ')}`;
            
            if (mostrarProjeccio) {
                chart.data.datasets[2].data = Array(percentatges.length).fill(null).concat(projeccio);
                chart.data.datasets[2].hidden = false;
            } else {
                chart.data.datasets[2].hidden = true;
            }
            
            // Actualitzar títol
            const titol = municipiSeleccionat === 'tots' 
                ? 'Evolució de la Recollida Selectiva a Catalunya i Metes UE' 
                : `Evolució de la Recollida Selectiva a ${municipiSeleccionat} i Metes UE`;
            
            chart.options.plugins.title.text = titol;
            
            chart.update();
        }
        
        // Calcular mitjana per a tota Catalunya per any
        function calcularMitjanaCatalunya() {
            const anys = [...new Set(allData.map(d => d.any))].sort((a, b) => a - b);
            const resultat = [];
            
            anys.forEach(any => {
                const dadesAny = allData.filter(d => d.any === any);
                
                // Calcular mitjana ponderada per població
                let totalPoblacio = 0;
                let totalPonderat = 0;
                
                dadesAny.forEach(d => {
                    const pes = d.poblaci;
                    totalPonderat += d.r_s_r_m_total * pes;
                    totalPoblacio += pes;
                });
                
                const mitjana = totalPonderat / totalPoblacio;
                
                resultat.push({
                    any: any,
                    r_s_r_m_total: mitjana,
                    municipi: 'Mitjana Catalunya'
                });
            });
            
            return resultat;
        }
        
        // Regressió lineal simple
        function linearRegression(x, y) {
            const n = x.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            
            for (let i = 0; i < n; i++) {
                sumX += x[i];
                sumY += y[i];
                sumXY += x[i] * y[i];
                sumXX += x[i] * x[i];
            }
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            
            return { slope, intercept };
        }
    </script>
</body>
</html>