<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <title>Comparativa de Residus Municipals</title>
  <!-- Enllaç a Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Enllaç a Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      padding: 20px;
      background-color: #f8f9fa; /* Fons gris clar */
    }
    .chart-container {
      width: 90%;
      max-width: 400px;
    }
    .chart-wrapper {
      display: flex;
      flex-wrap: wrap;
      gap: 40px;
      justify-content: center;
      background-color: transparent;
    }
    .filtres {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 1.5rem;
      background-color: transparent;
    }
    .filtre {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      min-width: 200px;
    }
    .filtre select {
      width: 150px;
      background-color: #f1f3f5;
      border-color: #ced4da;
    }

    
  </style>
</head>
<body>
  <!-- <h1 class="mb-4 text-center">Comparativa de Residus Municipals per Any</h1> -->

  <div class="filtres">
    <div class="filtre">
      <label for="any1">Any 1:</label>
      <select id="any1" class="form-select form-select-sm"></select>
    </div>
    <div class="filtre">
      <label for="any2">Any 2:</label>
      <select id="any2" class="form-select form-select-sm"></select>
    </div>
  </div>

  <div class="chart-wrapper">
    <div class="chart-container">
      <canvas id="grafica1"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="grafica2"></canvas>
    </div>
  </div>

  <script>
    const API_URL = 'https://analisi.transparenciacatalunya.cat/resource/69zu-w48s.json?$limit=23000';
    // const API_URL = '../../api/residus.php';

    let dades = [];
    let anysDisponibles = [];

    const selectAny1 = document.getElementById('any1');
    const selectAny2 = document.getElementById('any2');

    let grafica1, grafica2;

    async function obtenirDades() {
      try {
        const resposta = await fetch(API_URL);
        const dadesJSON = await resposta.json();
        dades = dadesJSON;

        const anys = [...new Set(dades.map(item => item.any))].sort();
        anysDisponibles = anys;

        anys.forEach(any => {
          const opcio1 = document.createElement('option');
          opcio1.value = any;
          opcio1.textContent = any;
          selectAny1.appendChild(opcio1);

          const opcio2 = document.createElement('option');
          opcio2.value = any;
          opcio2.textContent = any;
          selectAny2.appendChild(opcio2);
        });

        selectAny1.value = '2015';
        selectAny2.value = '2023';

        actualitzarGrafiques();
      } catch (error) {
        console.error('Error en obtenir les dades:', error);
      }
    }

    function classificar(percentatge) {
      const valor = parseFloat(percentatge);
      if (valor >= 60) return 'Verd (Bona gestió)';
      else if (valor >= 40) return 'Groc (Mitjana)';
      else return 'Vermell (Dolenta)';
    }

    function obtenirDadesPerAny(any) {
      const dadesAny = dades.filter(item => item.any === any);
      const classificacions = {
        'Verd (Bona gestió)': 0,
        'Groc (Mitjana)': 0,
        'Vermell (Dolenta)': 0
      };

      dadesAny.forEach(item => {
        const percentatge = item.r_s_r_m_total;
        if (percentatge !== undefined) {
          const categoria = classificar(percentatge);
          classificacions[categoria]++;
        }
      });

      return classificacions;
    }

    function generarGrafica(ctx, dades, any) {
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(dades),
          datasets: [{
            label: `Nombre de municipis (${any})`,
            data: Object.values(dades),
            backgroundColor: ['green', 'gold', 'red']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: `Classificació dels municipis segons % de recollida selectiva (${any})`
            },
            legend: {
              display: false
            }
          }
        }
      });
    }

    function actualitzarGrafiques() {
      const any1 = selectAny1.value;
      const any2 = selectAny2.value;

      const dadesAny1 = obtenirDadesPerAny(any1);
      const dadesAny2 = obtenirDadesPerAny(any2);

      if (grafica1) grafica1.destroy();
      if (grafica2) grafica2.destroy();

      const ctx1 = document.getElementById('grafica1').getContext('2d');
      const ctx2 = document.getElementById('grafica2').getContext('2d');

      grafica1 = generarGrafica(ctx1, dadesAny1, any1);
      grafica2 = generarGrafica(ctx2, dadesAny2, any2);
    }

    selectAny1.addEventListener('change', actualitzarGrafiques);
    selectAny2.addEventListener('change', actualitzarGrafiques);

    obtenirDades();
  </script>
</body>
</html>
