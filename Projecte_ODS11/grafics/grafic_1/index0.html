<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evolució de Residus Municipals Catalunya</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .chart-container {
            position: relative;
            height: 500px;
            margin: 20px 0;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
    </style>
</head>
<body>
    <div id="chart-container" class="chart-container">
        <canvas id="chart"></canvas>
    </div>

    <script>
        let chart = null;
        let dadesOriginais = [];

        async function carregarDades() {
            try {
                const response = await fetch('https://analisi.transparenciacatalunya.cat/resource/69zu-w48s.json?$limit=23000');
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data || data.length === 0) {
                    throw new Error('No s\'han rebut dades de l\'API');
                }
                
                // Processar i emmagatzemar dades originales
                dadesOriginais = data.map(row => ({
                    any: parseInt(row.any),
                    municipi: row.municipi,
                    comarca: row.comarca,
                    poblacio: parseFloat(row.poblaci) || 0,
                    kgHabAny: parseFloat(row.kg_hab_any) || 0,
                    kgHabAnySelectiva: parseFloat(row.kg_hab_any_recollida_selectiva) || 0,
                    percentatgeSelectiva: parseFloat(row.r_s_r_m_total) || 0,
                    totalSelectiva: parseFloat(row.total_recollida_selectiva) || 0,
                    resta: parseFloat(row.suma_fracci_resta) || 0
                })).filter(row => !isNaN(row.any) && row.any > 1990 && row.any < 2030);

                processarDades(dadesOriginais);
                
            } catch (error) {
                console.error('Error carregant dades:', error);
            }
        }

        function processarDades(dades) {
            try {
                if (dades.length === 0) {
                    throw new Error('No hi ha dades vàlides després del processament');
                }

                // Calcular mitjanes anuals de tots els municipis
                const mitjanesPorAny = {};
                
                dades.forEach(row => {
                    if (!mitjanesPorAny[row.any]) {
                        mitjanesPorAny[row.any] = {
                            kgHabAny: [],
                            kgHabAnySelectiva: [],
                            percentatgeSelectiva: [],
                            poblacioTotal: 0,
                            municipis: new Set()
                        };
                    }
                    
                    if (row.kgHabAny > 0) mitjanesPorAny[row.any].kgHabAny.push(row.kgHabAny);
                    if (row.kgHabAnySelectiva > 0) mitjanesPorAny[row.any].kgHabAnySelectiva.push(row.kgHabAnySelectiva);
                    if (row.percentatgeSelectiva > 0) mitjanesPorAny[row.any].percentatgeSelectiva.push(row.percentatgeSelectiva);
                    mitjanesPorAny[row.any].poblacioTotal += row.poblacio;
                    mitjanesPorAny[row.any].municipis.add(row.municipi);
                });

                // Calcular mitjanes reals
                const evolucioMitjana = Object.keys(mitjanesPorAny)
                    .map(any => parseInt(any))
                    .sort((a, b) => a - b)
                    .map(any => {
                        const dadesMitjanes = mitjanesPorAny[any];
                        return {
                            any: any,
                            kgHabAny: dadesMitjanes.kgHabAny.length > 0 ? 
                                dadesMitjanes.kgHabAny.reduce((a, b) => a + b, 0) / dadesMitjanes.kgHabAny.length : 0,
                            kgHabAnySelectiva: dadesMitjanes.kgHabAnySelectiva.length > 0 ? 
                                dadesMitjanes.kgHabAnySelectiva.reduce((a, b) => a + b, 0) / dadesMitjanes.kgHabAnySelectiva.length : 0,
                            percentatgeSelectiva: dadesMitjanes.percentatgeSelectiva.length > 0 ? 
                                dadesMitjanes.percentatgeSelectiva.reduce((a, b) => a + b, 0) / dadesMitjanes.percentatgeSelectiva.length : 0,
                            poblacioTotal: dadesMitjanes.poblacioTotal,
                            numMunicipis: dadesMitjanes.municipis.size
                        };
                    })
                    .filter(row => row.kgHabAny > 0);

                if (evolucioMitjana.length === 0) {
                    throw new Error('No s\'han pogut calcular mitjanes vàlides');
                }

                crearGrafic(evolucioMitjana);
                
            } catch (error) {
                console.error('Error processant dades:', error);
            }
        }

        function crearGrafic(dades) {
            const ctx = document.getElementById('chart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }

            const titleText = 'Evolució de la generació de residus i recollida selectiva (mitjana anual)';
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dades.map(d => d.any),
                    datasets: [
                        {
                            label: 'Total residus (kg/hab/any)',
                            data: dades.map(d => d.kgHabAny),
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Recollida selectiva (kg/hab/any)',
                            data: dades.map(d => d.kgHabAnySelectiva),
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            yAxisID: 'y'
                        },
                        {
                            label: '% Recollida selectiva',
                            data: dades.map(d => d.percentatgeSelectiva),
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            borderDash: [5, 5],
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: titleText,
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            padding: 20
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Any',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Kg per càpita',
                                color: '#e74c3c',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(231, 76, 60, 0.1)'
                            },
                            ticks: {
                                color: '#e74c3c'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '% Recollida selectiva',
                                color: '#3498db',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                                color: 'rgba(52, 152, 219, 0.1)'
                            },
                            ticks: {
                                color: '#3498db'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        // Inicialitzar l'aplicació
        window.addEventListener('load', carregarDades);
    </script>
</body>
</html>