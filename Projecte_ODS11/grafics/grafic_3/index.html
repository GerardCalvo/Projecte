<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <title>Distribució Fracció Resta per Tractament</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      padding: 20px;
    }
    .chart-container {
      max-width: 500px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <!-- <h1>Distribució de la fracció resta per tipus de tractament</h1> -->

  <div class="row g-3 align-items-center">
    <div class="col-md-4">
      <label for="selectAny" class="form-label">Selecciona any:</label>
      <select id="selectAny" class="form-select"></select>
    </div>
    <div class="col-md-6">
      <label for="selectMunicipi" class="form-label">Selecciona municipi (opcional):</label>
      <select id="selectMunicipi" class="form-select">
        <option value="">Tots els municipis</option>
      </select>
    </div>
  </div>

  <div class="chart-container">
    <canvas id="pieChart"></canvas>
  </div>

  <script>
    const API_URL = '../../api/residus.php';
    //const API_URL = 'https://analisi.transparenciacatalunya.cat/resource/69zu-w48s.json?$limit=23000';

    let dades = [];
    let anysDisponibles = [];
    let municipisDisponibles = [];

    const selectAny = document.getElementById('selectAny');
    const selectMunicipi = document.getElementById('selectMunicipi');

    let pieChart;

    async function obtenirDades() {
      try {
        const res = await fetch(API_URL);
        dades = await res.json();

        // Obtenir anys únics i ordenar
        anysDisponibles = [...new Set(dades.map(d => d.any))].sort();
        anysDisponibles.forEach(any => {
          const opt = document.createElement('option');
          opt.value = any;
          opt.textContent = any;
          selectAny.appendChild(opt);
        });

        // Assignar any per defecte (el més recent)
        selectAny.value = anysDisponibles[anysDisponibles.length - 1];

        // Obtenir municipis únics i ordenar alfabeticament
        municipisDisponibles = [...new Set(dades.map(d => d.municipi))].sort();
        municipisDisponibles.forEach(muni => {
          const opt = document.createElement('option');
          opt.value = muni;
          opt.textContent = muni;
          selectMunicipi.appendChild(opt);
        });

        actualitzarGrafica();
      } catch (error) {
        console.error('Error carregant dades:', error);
      }
    }

    function sumarFraccions(filteredDades) {
      // Camps que sumem
      const fraccions = ['resta_a_dip_sit', 'resta_a_incineraci', 'resta_a_tractament_mec_nic'];

      // Inicialitzar suma
      let suma = {
        'Resta a Dipòsit': 0,
        'Resta a Incineració': 0,
        'Resta a Tractament Mecànic Biològic': 0
      };

      filteredDades.forEach(d => {
        fraccions.forEach((camp, i) => {
          let valor = parseFloat(d[camp]);
          if (!isNaN(valor)) {
            if (camp === 'resta_a_dip_sit') suma['Resta a Dipòsit'] += valor;
            else if (camp === 'resta_a_incineraci') suma['Resta a Incineració'] += valor;
            else if (camp === 'resta_a_tractament_mec_nic') suma['Resta a Tractament Mecànic Biològic'] += valor;
          }
        });
      });

      return suma;
    }

    function actualitzarGrafica() {
      const anySel = selectAny.value;
      const muniSel = selectMunicipi.value;

      // Filtrar dades per any i municipi (si està seleccionat)
      let dadesFiltrades = dades.filter(d => d.any === anySel);
      if (muniSel) {
        dadesFiltrades = dadesFiltrades.filter(d => d.municipi === muniSel);
      }

      const sumaFraccions = sumarFraccions(dadesFiltrades);

      const ctx = document.getElementById('pieChart').getContext('2d');

      if (pieChart) {
        pieChart.destroy();
      }

      pieChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: Object.keys(sumaFraccions),
          datasets: [{
            label: 'Distribució Fracció Resta',
            data: Object.values(sumaFraccions),
            backgroundColor: [
              'rgba(54, 162, 235, 0.7)',   // blau
              'rgba(255, 99, 132, 0.7)',   // vermell
              'rgba(255, 206, 86, 0.7)'    // groc
            ],
            borderColor: 'white',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: `Distribució de la fracció resta per tipus de tractament (${anySel}${muniSel ? ', ' + muniSel : ''})`
            },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.label}: ${ctx.parsed.toFixed(2)}`
              }
            }
          }
        }
      });
    }

    selectAny.addEventListener('change', () => {
      // Quan canvia any, reset municipi a "tots"
      selectMunicipi.value = '';
      actualitzarGrafica();
    });
    selectMunicipi.addEventListener('change', actualitzarGrafica);

    obtenirDades();
  </script>
</body>
</html>
